<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Información</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f4f4f4;
            font-family: Arial, sans-serif;
        }

        .main-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            background-color: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 350px;
            margin-top: 200px;
        }

        .main-container h1 {
            text-align: center;
        }

        select {
            display: block;
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            font-size: 1rem;
        }

        label, input, button {
            display: block;
            width: 100%;
            padding: 10px;
            margin-bottom: 5px;
            font-size: 1rem;
        }

        .input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 15px;
            margin-top: 5px;
        }

        button {
            background-color: #2c3e50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            margin-bottom: 2px;
            margin-top: 20px;
        }

        button:hover {
            background-color: #1abc9c;
        }

        button[disabled] {
            background-color: #ccc;
            cursor: not-allowed;
        }

        a button {
            background-color: #e74c3c;
            margin-top: 5px;
        }

        a button:hover {
            background-color: #c0392b;
        }

        #noChangesWarning {
            display: none;
            color: red; /* Cambia esto según el tipo de mensaje */
            text-align: center;
        }
    </style>
</head>
<body>

    <div class="main-container">
        <h1>Editar Información</h1>
    
        <form id="editForm" method="POST" action="/editData/">
            {% csrf_token %}
            <label for="nameSelect">Selecciona el usuario:</label>
            <select id="nameSelect" name="fullName" required>
                <!-- Opciones se cargarán aquí -->
            </select>
    
            <div class="input-group">
                <input type="hidden" id="originalId" name="originalId">
                <label for="editId">RUT:</label>
                <input type="text" id="editId" name="rut" required placeholder="Ej: 21026807" maxlength="9">
                
                <input type="hidden" id="originalName" name="originalName">
                <label for="editName">Nombre:</label>
                <input type="text" id="editName" name="nombre" required>
            </div>
    
            <div class="input-group">
                <input type="hidden" id="originalLastName" name="originalLastName">
                <label for="editLastName">Apellido Paterno:</label>
                <input type="text" id="editLastName" name="apellido_p" required>
    
                <input type="hidden" id="originalMotherLastName" name="originalMotherLastName">
                <label for="editMotherLastName">Apellido Materno:</label>
                <input type="text" id="editMotherLastName" name="apellido_m" required>
            </div>
    
            <div class="input-group">
                <input type="hidden" id="originalDate" name="originalDate">
                <label for="editDate">Fecha de Nacimiento:</label>
                <input type="date" id="editDate" name="fecha_n" required>
            </div>
    
            <div class="input-group">
                <input type="hidden" id="originalEmail" name="originalEmail">
                <label for="editEmail">Correo:</label>
                <input type="email" id="editEmail" name="correo" required>
    
                <input type="hidden" id="originalTelefono" name="originalTelefono">
                <label for="editTelefono">Teléfono:</label>
                <input type="text" id="editTelefono" name="telefono" required>
            </div>
    
            <button type="submit" id="saveChanges" disabled>Guardar Cambios</button>
            <div id="noChangesWarning" style="display: none;">No se han realizado cambios. Por favor, modifica algún campo para guardar.</div>
        </form>
           
        <a href="{% url 'inicio_admin' %}"><button>Volver a la Página Principal</button></a>
    </div>

    <script>
        // Función para limpiar todos los campos
        function clearForm() {
            document.getElementById('editId').value = '';
            document.getElementById('editName').value = '';
            document.getElementById('editLastName').value = '';
            document.getElementById('editMotherLastName').value = '';
            document.getElementById('editDate').value = '';
            document.getElementById('editEmail').value = '';
            document.getElementById('editTelefono').value = '';
            document.getElementById('saveChanges').disabled = true;
            document.getElementById('noChangesWarning').style.display = 'none'; // Ocultar el mensaje de advertencia
        }
    
        // Cargar nombres desde la base de datos
        async function loadNames() {
            try {
                const response = await fetch('/getNames');
                const names = await response.json();
                const select = document.getElementById('nameSelect');
                select.innerHTML = '';
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Selecciona un usuario';
                defaultOption.disabled = true;
                defaultOption.selected = true;
                select.appendChild(defaultOption);
    
                names.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name; // Valor del option es el fullName
                    option.textContent = name; // Nombre completo
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error cargando nombres:', error);
            }
        }
    
        // Cargar datos del usuario seleccionado
        async function loadUserData(fullName) {
            try {
                const response = await fetch(`/getUserData?fullName=${encodeURIComponent(fullName)}`);
                const userData = await response.json();
                
                // Rellenar los campos del formulario con los datos del usuario
                document.getElementById('editId').value = userData.rut;
                document.getElementById('originalId').value = userData.rut;
                document.getElementById('editName').value = userData.nombre;
                document.getElementById('originalName').value = userData.nombre;
                document.getElementById('editLastName').value = userData.apellido_p;
                document.getElementById('originalLastName').value = userData.apellido_p;
                document.getElementById('editMotherLastName').value = userData.apellido_m;
                document.getElementById('originalMotherLastName').value = userData.apellido_m;
                document.getElementById('editDate').value = userData.fecha_n;
                document.getElementById('originalDate').value = userData.fecha_n;
                document.getElementById('editEmail').value = userData.correo;
                document.getElementById('originalEmail').value = userData.correo;
                document.getElementById('editTelefono').value = userData.telefono;
                document.getElementById('originalTelefono').value = userData.telefono;
                document.getElementById('saveChanges').disabled = false; // Habilitar botón de guardar cambios
            } catch (error) {
                console.error('Error cargando datos del usuario:', error);
            }
        }
    
        // Evento para cambiar el usuario seleccionado
        document.getElementById('nameSelect').addEventListener('change', function() {
            const selectedFullName = this.value;
            if (selectedFullName) {
                loadUserData(selectedFullName);
            } else {
                clearForm(); // Limpiar formulario si no hay selección
            }
        });
    
        // Manejar el envío del formulario
        document.getElementById('editForm').addEventListener('submit', async function(event) {
            event.preventDefault(); // Prevenir el comportamiento predeterminado del formulario
            const formData = new FormData(this);

            try {
                const response = await fetch(this.action, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                // Verificar si se han realizado cambios
                if (result.error) {
                    document.getElementById('noChangesWarning').style.display = 'block';
                } else {
                    clearForm(); 
                    window.location.href = "{% url 'success_edit' %}";
                    loadNames();
                }
            } catch (error) {
                console.error('Error al enviar el formulario:', error);
            }
        });
    
        // Inicializar
        loadNames();
    </script>

</body>
</html>